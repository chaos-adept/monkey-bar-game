<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game</title>
    <style type="text/css">
        .hidden {
            display: none;
        }
        .visible {
            display: block;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.13.1/lodash.min.js"></script>


</head>
<body onload="onDomLoaded(event)">
    <h1> monkey tournament game </h1>

    <form action="/logout" method="post">
        <input type="submit" value="logout"/>
    </form>

    <div id="userInfoPanel">
        <input id="playerId" placeholder="playerId"/>
        <button onclick="onRegisterRequest(event)">register</button>
    </div>

    <br/>
    <div id="turnsPanel">
        <input id="attempt" placeholder="command body (json)" type="number" value="0" />
        <button onclick="onAttempt(event)">turn</button>
        <span data-sid="player-name" id="status"></span>
        <br/>
        <div id="scoresPanel">
            <ol id="scores"></ol>
        </div>
    </div>
    <div id="profile">

    </div>


    <script>
        var playerTurnHash = 0;
        var socket = io('', {'transports': ['websocket']});
        socket.on('connect', function(){ console.log('connected'); updateStatus('connected'); });
        socket.on('event', function(data){ console.log('event', data); });
        socket.on('disconnect', function(){ console.log('disconnected'); updateStatus('disconnected'); });

        socket.on('welcome', onRegister);
        socket.on('scores', onScoresUpdate);

        function onRegister(player) {

            const s = `
                <ul>
                    <li><span><a href="${player.profileUrl}"> ${player.displayName} </a></span></li>
                    <li><span>${player.id}</span></li>
                    <li><span>${player.photos.map(it => `<img src="${it.value}"/>`)}</span></li>
                </ul>
            `;
            var div = document.getElementById('profile');
            div.innerHTML = s;

            setVisibleTurnsPanel(true);
        }

        function onRegisterRequest(event) {
            var playerId = document.getElementById('playerId').value;
            socket.emit('register', playerId);
        }

        function onAttempt(event) {
            var value = +document.getElementById('attempt').value;
            socket.emit('turn', { value: value, turnHash: ++playerTurnHash });
        }

        function updateStatus(newStatus) {
            document.getElementById('status').innerText = newStatus;
        }

        function onDomLoaded() {
            document.getElementById('playerId').value = localStorage.username || '';

            setVisibleUserInfoPanel(false);
            setVisibleTurnsPanel(false);
        }

        function onScoresUpdate(scores) {
            var s = _.map(scores, function (it) { return '<li>' + it.playerId + ' - ' + it.score + '</li>' }).join(' ');

            var div = document.getElementById('scores');
            div.innerHTML = s;
        }

        function setVisibleUserInfoPanel(visible) {
            document.getElementById('userInfoPanel').className = visible ? 'visible' : 'hidden';
        }

        function setVisibleTurnsPanel(visible) {
            document.getElementById('turnsPanel').className = visible ? 'visible' : 'hidden';
        }
    </script>

</body>
</html>