<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game</title>
    <style type="text/css">
        .hidden {
            display: none;
        }

        .visible {
            display: block;
        }

        .vcenter {
            vertical-align: middle;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.13.1/lodash.min.js"></script>

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

</head>
<body onload="onDomLoaded(event)">
<div class="container">
    <div class="row">
        <div class="col-xs-12 col-md-8">
            <div class="page-header">
                <h1>monkey tournament game
                    <small><span id="status"></span></small>
                </h1>
                <div class="col-xs-12 col-md-8" id="profile">
                </div>
            </div>
        </div>

    </div>
    <div class="row">

    </div>
    <div class="row">
        <!--<form action="/logout" method="get">-->
            <!--<div class="form-group">-->
                <!--<input type="submit" value="logout"/>-->
            <!--</div>-->
        <!--</form>-->
    </div>
    <div class="row">
        <div class="col-xs-12 col-md-8">
            <h4>Turn <small></small></h4>
            <div id="turnsPanel">
                <div class="input-group">

                    <input id="attempt" type="number" value="1" class="form-control" placeholder="Search for...">

                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button" onclick="onAttempt(event)">Go!</button>
                    </span>
                </div><!-- /input-group -->
            </div>


            <br/>


        </div>
    </div>
    <div class="row">
        <div class="col-xs-12 col-md-8">
            <h4>Results <small></small></h4>
            <div id="scoresPanel">
                <ol id="scores"></ol>
            </div>
        </div>
    </div>
</div>


<script>
    var playerTurnHash = 0;
    var socket = io('', {'transports': ['websocket']});
    socket.on('connect', function () {
        console.log('connected');
        setVisibleUserInfoPanel(false);
        setVisibleTurnsPanel(false);
        updateStatus('connected');
    });
    socket.on('event', function (data) {
        console.log('event', data);
    });
    socket.on('disconnect', function () {
        console.log('disconnected');
        updateStatus('disconnected');
    });

    socket.on('welcome', onRegister);
    socket.on('scores', onScoresUpdate);

    function onRegister(player) {
        const s = `
               <span>${player.photos.map(it => `<img class="img-circle" src="${it.value}"/>`)}</span> <span><a href="${player.profileUrl}"> <span data-sid="player-name">${player.displayName}</span> </a> (<a href="/logout">logout</a>)</span>
            `;
        var div = document.getElementById('profile');
        div.innerHTML = s;

        setVisibleTurnsPanel(true);
    }

    function onAttempt(event) {
        var value = +document.getElementById('attempt').value;
        socket.emit('turn', {value: value, turnHash: ++playerTurnHash});
    }

    function updateStatus(newStatus) {
        document.getElementById('status').innerText = newStatus;
    }

    function onDomLoaded() {
    }

    function onScoresUpdate(scores) {
        var s = _.map(scores, function (it) {
            const imgTags = `<div>${it.player.photos.map(photo => `<img src="${photo.value}"/>`)}</div>`;
            return `<li class="media">
                        <div class="media-left media-middle"><div class="media-object">${imgTags}</div>  </div>
                        <div class="media-body">
                          <h4 class="media-heading"> <span class="badge">${it.score}</span> </h4>
                          <h5><span>${it.player.displayName} </span> </h5>
                        </div>



                        </li>`;
        }).join(' ');

        var div = document.getElementById('scores');
        div.innerHTML = ` <ul class="media-list"> ${s} </ul> `;
    }

    function setVisibleUserInfoPanel(visible) {
        document.getElementById('userInfoPanel').className = visible ? 'visible' : 'hidden';
    }

    function setVisibleTurnsPanel(visible) {
        console.log('visible', visible);
        document.getElementById('turnsPanel').className = visible ? 'visible' : 'hidden';
    }
</script>


<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
</body>
</html>